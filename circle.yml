machine:
  php:
    version: 7.0.4
  environment:
    # Add composer and npm binaries to path.
    PATH: "${HOME}/${CIRCLE_PROJECT_REPONAME}/vendor/bin:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin:$HOME/.composer/vendor/bin:$PATH"
    COMPOSER_EXIT_ON_PATCH_FAILURE: 1

dependencies:
  override:
    - nvm install
    - npm install
    - gulp install
  cache_directories:
    - "~/.composer/cache"
    - "~/.npm"
    - "~/.bower"

database:
  override:
    - cp ci/settings.circle.php web/sites/default/settings.local.php
    - vendor/bin/drupal --root=web/ -n site:install

test:
  override:
    - nohup vendor/bin/drupal --root=web/ server 127.0.0.1:8888 > /dev/null 2>&1:
        background: true
    - composer validate
    - gulp check
    - gulp build
    - gulp test

